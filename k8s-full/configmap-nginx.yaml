apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: chat-app
data:
  nginx.conf: |
    # 워커 프로세스 레벨 설정 (여기서는 기본값 사용)
    events {}

    http {
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host  $host;
        proxy_read_timeout 300s;

        log_format proxy_debug
            'client:$remote_addr '
            'vhost:$host '
            'method:$request_method '
            'req:"$request_uri" '
            'norm_uri:"$uri" '
            'upstream_name:$upstream_name '
            'upstream_addr:$upstream_addr '
            'status:$status(up:$upstream_status) '
            'rt:$request_time urt:$upstream_response_time';

        access_log /dev/stdout proxy_debug;
        error_log  /dev/stderr warn;

        map $http_upgrade $connection_upgrade {
            default upgrade;
            ''      close;
        }

        upstream chat_ws        { server chat-ws:8080; }
        upstream chat_history   { server chat-history:8080; }
        upstream app_service    { server app-service:8080; }
        upstream app_media      { server app-media:8080; }
        upstream app_auth       { server app-auth:8080; }

        server {
            listen 80;
            set $upstream_name "-";

            location = / {
                add_header Content-Type text/plain;
                return 200 "NGINX reverse proxy is up. Try /ws-sockjs, /history, /api, /media, /auth\n";
            }

            location /ws-sockjs {
                set $upstream_name "chat_ws";
                proxy_pass http://chat_ws;
                proxy_http_version 1.1;
                proxy_set_header Upgrade    $http_upgrade;
                proxy_set_header Connection $connection_upgrade;
                proxy_set_header Host              $host;
                proxy_set_header X-Real-IP         $remote_addr;
                proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Forwarded-Host  $host;
                proxy_read_timeout  3600;
                proxy_send_timeout  3600;
            }

            location /chat/ {
                set $upstream_name "chat_ws";
                proxy_pass http://chat_ws;
            }

            location /history/ {
                set $upstream_name "chat_history";
                proxy_pass http://chat_history;
            }

            location /api/ {
                set $upstream_name "app_service";
                proxy_pass http://app_service;
            }

            location /media/ {
                set $upstream_name "app_media";
                proxy_pass http://app_media;
            }

            location /auth/ {
                set $upstream_name "app_auth";
                proxy_pass http://app_auth;
            }
        }
    }
