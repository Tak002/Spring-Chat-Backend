events {}

http {
  # 공통 프록시 헤더/타임아웃
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_read_timeout 300s;

  # 업스트림: compose 서비스명 + 내부포트(8080)
  upstream chat_ws        { server chat-ws:8080; }
  upstream chat_history   { server chat-history:8080; }
  upstream app_service    { server app-service:8080; }
  upstream app_media      { server app-media:8080; }
  upstream app_auth       { server app-auth:8080; }

  server {
    listen 80;

    # 루트 확인용
    location = / {
      return 200 "NGINX reverse proxy is up. Try /ws, /history, /api, /media, /auth\n";
      add_header Content-Type text/plain;
    }

    # WebSocket 엔드포인트 (예: /ws)
    location /ws {
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_pass http://chat_ws;
    }

    # 나머지 경로 기반 라우팅
    location /chat/ { proxy_pass http://chat-ws/; }
    location /history/ { proxy_pass http://chat_history; }
    location /api/     { proxy_pass http://app_service;  }
    location /media/   { proxy_pass http://app_media;    }
    location /auth/ {
        rewrite ^/auth(/.*)$ $1 break;
        proxy_pass http://app_auth;

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
  }
}
